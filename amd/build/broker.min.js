define ("mod_bigbluebuttonbn/broker",["jquery","core/config","core/str","mod_bigbluebuttonbn/rooms"],function(a,b,c,d){return{datasource:null,bigbluebuttonbn:{},init:function init(a){this.datasource=b.wwwroot+"/mod/bigbluebuttonbn/bbb_ajax.php?sesskey="+b.sesskey+"&";this.bigbluebuttonbn=a},joinRedirect:function joinRedirect(a){window.open(a)},recordingActionPerform:function recordingActionPerform(b){var c="action=recording_"+b.action+"&id="+b.recordingid+"&idx="+b.meetingid;c+=this.recordingActionMetaQS(b);b.attempt=1;if("undefined"==typeof b.attempts){b.attempts=5}a.getJSON({url:this.datasource+c}).done(function(a){if(!a.status){return M.mod_bigbluebuttonbn.recordings.recordingActionFailover(a)}if("undefined"==typeof a.goalstate){return M.mod_bigbluebuttonbn.recordings.recordingActionCompletion(a)}if(1>=a.attempts){return M.mod_bigbluebuttonbn.recordings.recordingActionPerformedComplete(a)}return M.mod_bigbluebuttonbn.recordings.recordingActionPerformedValidate(a)}).fail(function(a){b.message=a.message;return M.mod_bigbluebuttonbn.recordings.recordingActionFailover(b)})},recordingActionMetaQS:function recordingActionMetaQS(a){var b="";if("undefined"!=typeof a.source){var c={};c[a.source]=encodeURIComponent(a.goalstate);b+="&meta="+JSON.stringify(c)}return b},recordingActionPerformedValidate:function recordingActionPerformedValidate(b){var d="action=recording_info&id="+b.recordingid+"&idx="+b.meetingid;d+=this.recordingActionMetaQS(b);a.getJSON({url:this.datasource+d}).done(function(a){if(this.recordingActionPerformedComplete(a)){return}if(a.attempt<a.attempts){a.attempt+=1;setTimeout(function(){return function(){this.recordingActionPerformedValidate(a)}}(this),1e3*(a.attempt-1));return}a.message=c.get_string("view_error_action_not_completed","bigbluebuttonbn");M.mod_bigbluebuttonbn.recordings.recordingActionFailover(a)}).fail(function(a){b.message=a.message;M.mod_bigbluebuttonbn.recordings.recordingActionFailover(b)})},recordingActionPerformedComplete:function recordingActionPerformedComplete(a,b){if("undefined"==typeof a.data[b.source]){b.message=c.get_string("view_error_current_state_not_found","bigbluebuttonbn");M.mod_bigbluebuttonbn.recordings.recordingActionFailover(b);return!0}if(a.data[b.source]===b.goalstate){M.mod_bigbluebuttonbn.recordings.recordingActionCompletion(b);return!0}return!1},recordingCurrentState:function recordingCurrentState(a,b){if("publish"===a||"unpublish"===a){return b.published}if("delete"===a){return b.status}if("protect"===a||"unprotect"===a){return b.secured}if("update"===a){return b.updated}return null},endMeeting:function endMeeting(){var b="action=meeting_end&id="+this.bigbluebuttonbn.meetingid;b+="&bigbluebuttonbn="+this.bigbluebuttonbn.bigbluebuttonbnid;a.getJSON({url:this.datasource+b}).done(function(a){if(a.data.status){d.endMeeting();location.reload()}})},completionValidate:function completionValidate(b){a.getJSON({url:this.datasource+b}).done(function(a){if(a.data.status){var b=c.get_string("completionvalidatestatetriggered","bigbluebuttonbn");M.mod_bigbluebuttonbn.helpers.alertError(b,"info")}})}}});
//# sourceMappingURL=broker.min.js.map
