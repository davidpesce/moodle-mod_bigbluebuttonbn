define ("mod_bigbluebuttonbn/broker",["jquery","core/config","core/str","mod_bigbluebuttonbn/rooms","mod_bigbluebuttonbn/recordings"],function(a,b,c,d,e){var f=null,g={};return{init:function init(a){f=b.wwwroot+"/mod/bigbluebuttonbn/bbb_ajax.php?sesskey="+b.sesskey+"&";g=a},joinRedirect:function joinRedirect(a){window.open(a)},recordingActionPerform:function recordingActionPerform(b){var c="action=recording_"+b.action+"&id="+b.recordingid+"&idx="+b.meetingid;c+=this.recordingActionMetaQS(b);b.attempt=1;if("undefined"==typeof b.attempts){b.attempts=5}a.getJSON({url:f+c}).done(function(a){if(!a.status){return e.recordingActionFailover(a)}if("undefined"==typeof a.goalstate){return e.recordingActionCompletion(a)}if(1>=a.attempts){return e.recordingActionPerformedComplete(a)}return e.recordingActionPerformedValidate(a)}).fail(function(a){b.message=a.message;return e.recordingActionFailover(b)})},recordingActionMetaQS:function recordingActionMetaQS(a){var b="";if("undefined"!=typeof a.source){var c={};c[a.source]=encodeURIComponent(a.goalstate);b+="&meta="+JSON.stringify(c)}return b},recordingActionPerformedValidate:function recordingActionPerformedValidate(b){var d=this,g="action=recording_info&id="+b.recordingid+"&idx="+b.meetingid;g+=this.recordingActionMetaQS(b);a.getJSON({url:f+g}).done(function(a){if(d.recordingActionPerformedComplete(a)){return}if(a.attempt<a.attempts){a.attempt+=1;setTimeout(function(){return function(){d.recordingActionPerformedValidate(a)}}(this),1e3*(a.attempt-1));return}a.message=c.get_string("view_error_action_not_completed","bigbluebuttonbn");e.recordingActionFailover(a)}).fail(function(a){b.message=a.message;e.recordingActionFailover(b)})},recordingActionPerformedComplete:function recordingActionPerformedComplete(a,b){if("undefined"==typeof a.data[b.source]){b.message=c.get_string("view_error_current_state_not_found","bigbluebuttonbn");e.recordingActionFailover(b);return!0}if(a.data[b.source]===b.goalstate){e.recordingActionCompletion(b);return!0}return!1},recordingCurrentState:function recordingCurrentState(a,b){if("publish"===a||"unpublish"===a){return b.published}if("delete"===a){return b.status}if("protect"===a||"unprotect"===a){return b.secured}if("update"===a){return b.updated}return null},endMeeting:function endMeeting(){var b="action=meeting_end&id="+g.meetingid;b+="&bigbluebuttonbn="+g.bigbluebuttonbnid;a.getJSON({url:f+b}).done(function(a){if(a.data.status){d.endMeeting();location.reload()}})},completionValidate:function completionValidate(b){a.getJSON({url:this.datasource+b}).done(function(a){if(a.data.status){var b=c.get_string("completionvalidatestatetriggered","bigbluebuttonbn");M.mod_bigbluebuttonbn.helpers.alertError(b,"info")}})}}});
//# sourceMappingURL=broker.min.js.map
