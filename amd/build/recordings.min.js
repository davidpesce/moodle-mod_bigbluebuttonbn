define ("mod_bigbluebuttonbn/recordings",["jquery","core/config","core/str","mod_bigbluebuttonbn/helpers","core/yui","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f,g){var h=null,i={FORM_SEARCH_RECORDINGS:"#bigbluebuttonbn_recordings_searchform",SEARCH_TEXT:"#searchtext",RECORDING_IMPORTED:"data-imported"};return{init:function init(){var c=this;h=b.wwwroot+"/mod/bigbluebuttonbn/bbb_ajax.php?sesskey="+b.sesskey+"&";a("[id^=recording-delete-]").each(function(b,d){a(d).click(function(){c.recordingDelete(d)})});a("[id^=recording-unpublish-]").each(function(b,d){a(d).click(function(){c.recordingUnpublish(d)})});a("[id^=recording-publish-]").each(function(b,d){a(d).click(function(){c.recordingPublish(d)})});d.init()},recordingElementPayload:function recordingElementPayload(b){var c=a(b).closest("div");return{action:a(b).attr("data-action"),recordingid:c.attr("data-recordingid"),meetingid:c.attr("data-meetingid")}},recordingAction:function recordingAction(a,b,c){var d=this,e=this.recordingElementPayload(a);for(var h in c){e[h]=c[h]}if(!b){d.recordingActionPerform(e);return}f.create({type:f.types.SAVE_CANCEL,title:"Are you sure?",body:d.recordingConfirmationMessage(e)}).then(function(a){a.setSaveButtonText("Delete");a.getRoot().on(g.save,function(){d.recordingActionPerform(e)});a.show()})},recordingActionPerform:function recordingActionPerform(b){var c=this,d="action=recording_"+b.action+"&id="+b.recordingid+"&idx="+b.meetingid;d+=this.recordingActionMetaQS(b);b.attempt=1;if("undefined"==typeof b.attempts){b.attempts=5}a.getJSON({url:h+d}).done(function(a){if("undefined"==typeof b.goalstate){return c.recordingActionCompletion(b)}if(1>=b.attempts){return c.recordingActionPerformedComplete(a,b)}return c.recordingActionPerformedValidate(b)}).fail(function(a,d){b.message="Request failed: "+d+" responseText: "+a.responseText;return c.recordingActionFailover(b)})},recordingActionMetaQS:function recordingActionMetaQS(a){var b="";if("undefined"!=typeof a.source){var c={};c[a.source]=encodeURIComponent(a.goalstate);b+="&meta="+JSON.stringify(c)}return b},recordingActionPerformedValidate:function recordingActionPerformedValidate(b){var d=this,e="action=recording_info&id="+b.recordingid+"&idx="+b.meetingid;e+=this.recordingActionMetaQS(b);a.getJSON({url:h+e}).done(function(a){console.log(d.recordingActionPerformedComplete(a,b));if(d.recordingActionPerformedComplete(a,b)){return}if(b.attempt<b.attempts){b.attempt+=1;setTimeout(function(){return function(){d.recordingActionPerformedValidate(b)}}(this),1e3*(b.attempt-1));return}b.message=c.get_string("view_error_action_not_completed","bigbluebuttonbn");d.recordingActionFailover(b)}).fail(function(a,c){b.message="Request failed: "+c+" responseText: "+a.responseText;d.recordingActionFailover(b)})},recordingActionPerformedComplete:function recordingActionPerformedComplete(a,b){if("undefined"==typeof a[b.source]){b.message=M.util.get_string("view_error_current_state_not_found","bigbluebuttonbn");this.recordingActionFailover(b);return!0}if(a[b.source]===b.goalstate){console.log("desired state and goal state are equal");this.recordingActionCompletion(b);return!0}return!1},recordingCurrentState:function recordingCurrentState(a,b){if("publish"===a||"unpublish"===a){return b.published}if("delete"===a){return b.status}if("protect"===a||"unprotect"===a){return b.secured}if("update"===a){return b.updated}return null},recordingPublish:function recordingPublish(a){this.recordingAction(a,!1,{source:"published",goalstate:"true"})},recordingUnpublish:function recordingUnpublish(a){this.recordingAction(a,!1,{source:"published",goalstate:"false"})},recordingProtect:function recordingProtect(a){this.recordingAction(a,!1,{source:"protected",goalstate:"true"})},recordingUnprotect:function recordingUnprotect(a){this.recordingAction(a,!1,{source:"protected",goalstate:"false"})},recordingDelete:function recordingDelete(a){var b={source:"found",goalstate:!1},c=!0;if(this.recordingIsImported(a)){c=!1;b.source="status";b.goalstate=!0;b.attempts=1}this.recordingAction(a,c,b)},recordingImport:function recordingImport(a){this.recordingAction(a,!0,{})},recordingUpdate:function recordingUpdate(a){var b=Y.one(a),c=b.ancestor("div"),d={target:c.getAttribute("data-target"),source:c.getAttribute("data-source"),goalstate:b.getAttribute("data-goalstate")};this.recordingAction(a,!1,d)},recordingEdit:function recordingEdit(a){var b=Y.one(a),c=b.ancestor("div"),d=c.one("> span");d.hide();b.hide();var e=Y.Node.create("<input type=\"text\" class=\"form-control\"></input>");e.setAttribute("id",b.getAttribute("id"));e.setAttribute("value",d.getHTML());e.setAttribute("data-value",d.getHTML());e.on("keydown",this.recordingEditKeydown);e.on("focusout",this.recordingEditOnfocusout);c.append(e);e.focus().select()},recordingEditKeydown:function recordingEditKeydown(a){var b=a.which||a.keyCode;if(13==b){this.recordingEditPerform(a.currentTarget);return}if(27==b){this.recordingEditOnfocusout(a.currentTarget)}},recordingEditOnfocusout:function recordingEditOnfocusout(a){var b=a.ancestor("div");a.hide();b.one("> span").show();b.one("> a").show()},recordingEditPerform:function recordingEditPerform(a){var b=a.ancestor("div"),c=a.get("value").trim();a.setAttribute("data-action","edit");a.setAttribute("data-goalstate",c);a.hide();this.recordingUpdate(a.getDOMNode());b.one("> span").setHTML(c).show();b.one("> a").show()},recordingEditCompletion:function recordingEditCompletion(a,b){var c=d.elementId(a.action,a.target),e=Y.one("a#"+c+"-"+a.recordingid),f=e.ancestor("div"),g=f.one("> span");if("undefined"==typeof g){return}var h=f.one("> input");if(b){g.setHTML(h.getAttribute("data-value"))}h.remove()},recordingPlay:function recordingPlay(a){var b=Y.one(a);if(""===b.getAttribute("data-href")){d.alertError(M.util.get_string("view_recording_format_errror_unreachable","bigbluebuttonbn"));return}var c={target:b.getAttribute("data-target"),source:"published",goalstate:"true",attempts:1,dataset:b.getData()};this.windowVideoPlay=window.open("","_blank");this.windowVideoPlay.opener=null;this.recordingAction(a,!1,c)},recordingConfirmationMessage:function recordingConfirmationMessage(a){var b,e,f,g,h,i=[{key:"view_recording_"+a.action+"_confirmation",component:"bigbluebuttonbn"},{key:"view_recording",component:"bigbluebuttonbn"},{key:"view_recording_link",component:"bigbluebuttonbn"},{key:"view_recording_"+a.action+"_confirmation_warning_p",component:"bigbluebuttonbn"},{key:"view_recording_"+a.action+"_confirmation_warning_s",component:"bigbluebuttonbn"}];c.get_strings(i).done(function(c){b=c[0];if("undefined"==typeof b){return""}e=c[1];if("true"===Y.one("#playbacks-"+a.recordingid).get("dataset").imported){e=c[2]}b=b.replace("{$a}",e);if("import"===a.action){return b}f=d.elementId(a.action,a.target);g=Y.one("a#"+f+"-"+a.recordingid).get("dataset").links;if(0===g){return b}h=c[3];if(1===g){h=c[4]}h=h.replace("{$a}",g)+". ";return h+"\n\n"+b})},recordingActionCompletion:function recordingActionCompletion(b){var e,f,g;if("delete"===b.action){c.get_strings([{key:"view_message_norecordings",component:"bigbluebuttonbn"}]).done(function(c){g=a("div#recording-actionbar-"+b.recordingid).closest("td").closest("tr");f=g.closest("tbody");if(f.children("tr").length){e=a("#bigbluebuttonbn_view_recordings_content");e.before("<span>"+c+"</span>");a("#bigbluebuttonbn_recordings_table").remove();return}g.remove()})}if("import"===b.action){g=Y.one("div#recording-actionbar-"+b.recordingid).ancestor("td").ancestor("tr");g.remove();return}if("play"===b.action){this.windowVideoPlay.location.href=b.dataset.href;return}d.updateData(b);d.updateId(b);if("publish"===b.action){this.recordingPublishCompletion(b.recordingid);return}if("unpublish"===b.action){this.recordingUnpublishCompletion(b.recordingid)}},recordingActionFailover:function recordingActionFailover(a){d.alertError(a.message);if("edit"===a.action){this.recordingEditCompletion(a,!0)}},recordingPublishCompletion:function recordingPublishCompletion(b){var c=a("#playbacks-"+b);c.show();var e=a("#preview-"+b);if(null===e){return}e.show();d.reloadPreview(b)},recordingUnpublishCompletion:function recordingUnpublishCompletion(b){var c=a("#playbacks-"+b);c.hide();var d=a("#preview-"+b);if(null===d){return}d.hide()},recordingIsImported:function recordingIsImported(b){return a(b).prop(i.RECORDING_IMPORTED)}}});
//# sourceMappingURL=recordings.min.js.map
